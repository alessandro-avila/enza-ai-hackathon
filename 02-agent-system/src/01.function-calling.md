# Lab 1 Function Calling Power

## Introduction

### What is Function Calling

Function calling enables Large Language Models to interact with external systems. The LLM determines when to invoke a function based on instructions, function definitions, and user prompts. The LLM then returns structured data that can be used by the agent app to invoke a function.

It's up to the developer to implement the function logic within the agent app. In this workshop, we use function logic to execute SQL queries that are dynamically generated by the LLM.

### Enabling Function Calling

If you’re familiar with Azure OpenAI Function Calling, you know it requires you to define a function schema for the LLM.

With the Azure AI Agent Service and its Python SDK, you can define the function schema directly within the Python function’s docstring. This approach keeps the definition and implementation together, simplifying maintenance and enhancing readability.

For example, in the enza_data.py file, the async_fetch_sales_data_using_sqlite_query function uses a docstring to specify its signature, inputs, and outputs. The SDK parses this docstring to generate the callable function for the LLM:

```sh
    async def async_fetch_sales_data_using_sqlite_query(self: "SalesData", sqlite_query: str) -> str:
    """
    This function is used to answer user questions about Contoso sales data by executing SQLite queries against the database.

    :param sqlite_query: The input should be a well-formed SQLite query to extract information based on the user's question. The query result will be returned as a JSON object.
    :return: Return data in JSON serializable format.
    :rtype: str
    """
```

### Dynamic SQL Generation

When the app starts, it incorporates the database schema and key data into the instructions for the Azure AI Agent Service. Using this input, the LLM generates SQLite-compatible SQL queries to respond to user requests expressed in natural language.

## Exercise

1. Open the main.py
2. **Uncomment** the following lines by removing the "# " characters:

   ``` python
   # INSTRUCTIONS_FILE = "instructions/instructions_function_calling.txt"

   # toolset.add(functions)
   ```

3. Review the Code in main.py.

## Review the Instructions

1. Open the **shared/instructions/function_calling.txt** file.
2. Review how the instructions define the agent app’s behavior:
   - **Role definition**: The agent assists Contoso users with sales data inquiries in a polite, professional, and friendly manner.
   - **Context**: Contoso is an online retailer specializing in camping and sports gear.
   - **Tool description – “Sales Data Assistance”**:
      - Enables the agent to generate and run SQL queries.
      - Includes database schema details for query building.
      - Limits results to aggregated data with a maximum of 30 rows.
      - Formats output as Markdown tables.
   - **Response guidance**: Emphasizes actionable, relevant replies.
   - **User support tips**: Provides suggestions for assisting users.
   - **Safety and conduct**: Covers how to handle unclear, out-of-scope, or malicious queries.

   During the workshop, we’ll extend these instructions by introducing new tools to enhance the agent’s capabilities.

## Run the Agent App

1. Press **F5** to run the app.
2. In the terminal, you'll see the app start, and the agent app will prompt you to **Enter your query**.

## Start a conversation with the Agent

Start asking questions about Contoso sales data. For example:

Here is an example of the LLM response to the help query:

I’m here to help with your sales data inquiries at Contoso. Could you please provide more details about what you need assistance with? Here are some example queries you might consider:

What were the sales by region?
What was last quarter's revenue?
Which products sell best in Europe?
Total shipping costs by region?
Feel free to ask any specific questions related to Contoso sales data!